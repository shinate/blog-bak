---
layout: post
status: publish
published: true
title: REMOTE_ADDR，HTTP_CLIENT_IP，HTTP_X_FORWARDED_FOR
author:
  display_name: "莳子"
  login: admin
  email: shine.wangrs@gmail.com
  url: http://codante.org
author_login: admin
author_email: shine.wangrs@gmail.com
author_url: http://codante.org
wordpress_id: 423
wordpress_url: http://codante.org/?p=423
date: '2010-12-27 12:49:17 +0800'
date_gmt: '2010-12-27 04:49:17 +0800'
---
<p>[php]<br />
/**<br />
 * 获得用户的真实IP地址<br />
 *<br />
 * @access  public<br />
 * @return  string<br />
 */<br />
function real_ip()<br />
{<br />
    static $realip = NULL;</p>
<p>    if ($realip !== NULL)<br />
    {<br />
        return $realip;<br />
    }</p>
<p>    if (isset($_SERVER))<br />
    {<br />
        if (isset($_SERVER['HTTP_X_FORWARDED_FOR']))<br />
        {<br />
            $arr = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);</p>
<p>            /* 取X-Forwarded-For中第一个非unknown的有效IP字符串 */<br />
            foreach ($arr AS $ip)<br />
            {<br />
                $ip = trim($ip);</p>
<p>                if ($ip != 'unknown')<br />
                {<br />
                    $realip = $ip;</p>
<p>                    break;<br />
                }<br />
            }<br />
        }<br />
        elseif (isset($_SERVER['HTTP_CLIENT_IP']))<br />
        {<br />
            $realip = $_SERVER['HTTP_CLIENT_IP'];<br />
        }<br />
        else<br />
        {<br />
            if (isset($_SERVER['REMOTE_ADDR']))<br />
            {<br />
                $realip = $_SERVER['REMOTE_ADDR'];<br />
            }<br />
            else<br />
            {<br />
                $realip = '0.0.0.0';<br />
            }<br />
        }<br />
    }<br />
    else<br />
    {<br />
        if (getenv('HTTP_X_FORWARDED_FOR'))<br />
        {<br />
            $realip = getenv('HTTP_X_FORWARDED_FOR');<br />
        }<br />
        elseif (getenv('HTTP_CLIENT_IP'))<br />
        {<br />
            $realip = getenv('HTTP_CLIENT_IP');<br />
        }<br />
        else<br />
        {<br />
            $realip = getenv('REMOTE_ADDR');<br />
        }<br />
    }</p>
<p>    preg_match("/[\d\.]{7,15}/", $realip, $onlineip);<br />
    $realip = !empty($onlineip[0]) ? $onlineip[0] : '0.0.0.0';</p>
<p>    return $realip;<br />
}<br />
[/php]<br />
一、没有使用代理服务器的情况：<br />
      REMOTE_ADDR = 您的 IP<br />
      HTTP_VIA = 没数值或不显示<br />
      HTTP_X_FORWARDED_FOR = 没数值或不显示</p>
<p>二、使用透明代理服务器的情况：Transparent Proxies<br />
      REMOTE_ADDR = 最后一个代理服务器 IP<br />
      HTTP_VIA = 代理服务器 IP<br />
      HTTP_X_FORWARDED_FOR = 您的真实 IP ，经过多个代理服务器时，这个值类似如下：203.98.182.163, 203.98.182.163, 203.129.72.215。</p>
<p>  这类代理服务器还是将您的信息转发给您的访问对象，无法达到隐藏真实身份的目的。</p>
<p>三、使用普通匿名代理服务器的情况：Anonymous Proxies<br />
      REMOTE_ADDR = 最后一个代理服务器 IP<br />
      HTTP_VIA = 代理服务器 IP<br />
      HTTP_X_FORWARDED_FOR = 代理服务器 IP ，经过多个代理服务器时，这个值类似如下：203.98.182.163, 203.98.182.163, 203.129.72.215。<br />
隐藏了您的真实IP，但是向访问对象透露了您是使用代理服务器访问他们的。</p>
<p>四、使用欺骗性代理服务器的情况：Distorting Proxies<br />
      REMOTE_ADDR = 代理服务器 IP<br />
      HTTP_VIA = 代理服务器 IP<br />
      HTTP_X_FORWARDED_FOR = 随机的 IP ，经过多个代理服务器时，这个值类似如下：203.98.182.163, 203.98.182.163, 203.129.72.215。<br />
  告诉了访问对象您使用了代理服务器，但编造了一个虚假的随机IP代替您的真实IP欺骗它。</p>
<p>五、使用高匿名代理服务器的情况：High Anonymity Proxies (Elite proxies)<br />
      REMOTE_ADDR = 代理服务器 IP<br />
      HTTP_VIA = 没数值或不显示<br />
      HTTP_X_FORWARDED_FOR = 没数值或不显示 ，经过多个代理服务器时，这个值类似如下：203.98.182.163, 203.98.182.163, 203.129.72.215。</p>
<p>  完全用代理服务器的信息替代了您的所有信息，就象您就是完全使用那台代理服务器直接访问对象。</p>
<p>REMOTE_ADDR 是你的客户端跟你的服务器“握手”时候的IP。如果使用了“匿名代理”，REMOTE_ADDR将显示代理服务器的IP。<br />
HTTP_CLIENT_IP 是代理服务器发送的HTTP头。如果是“超级匿名代理”，则返回none值。同样，REMOTE_ADDR也会被替换为这个代理服务器的IP。<br />
$_SERVER['REMOTE_ADDR']; //访问端（有可能是用户，有可能是代理的）IP<br />
$_SERVER['HTTP_CLIENT_IP'];  //代理端的（有可能存在，可伪造）<br />
$_SERVER['HTTP_X_FORWARDED_FOR']; //用户是在哪个IP使用的代理（有可能存在，也可以伪造）</p>
